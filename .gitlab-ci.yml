image: "python:3.12-slim"

stages:
  - setup
  - test
  - audit
  - package

variables:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - .cache/pip

.base_job:
  before_script:
    - python -m venv venv
    - . venv/bin/activate
    - python -m pip install -U pip

setup_job:
  extends: .base_job
  stage: setup
  script:
    - python -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
    - python -m pip install -r requirements.txt
    - python -m pip install ruff black mypy pytest pytest-cov

lint_job:
  extends: .base_job
  stage: test
  script:
    - python -m pip install ruff black mypy
    - ruff check . --exclude "*.ipynb" --extend-exclude "venv"
    - black --check . --exclude "venv/|\.ipynb$"
    - mypy product || true

test_job:
  extends: .base_job
  stage: test
  script:
    - python -m pip install pytest pytest-cov torch torchvision
    - pytest -q --disable-warnings --maxfail=1

audit_job:
  extends: .base_job
  stage: audit
  script:
    - python -m pip install pandas
    - python product/scripts/filter_anchor_csvs.py
    - python product/scripts/audit_leakage.py

package_job:
  extends: .base_job
  stage: package
  script:
    - python -m pip install torch torchvision pandas PIL matplotlib
    - python product/training/train_unified.py --dataset emodb --model_type resnet50 --epochs 1 --batch_size 8 --train_csv product/artifacts/splits/train_emodb_no_aug.csv --val_csv product/artifacts/splits/val_emodb_no_aug.csv --run_name ci_smoke_test
  artifacts:
    paths:
      - product/artifacts/runs/emodb/ci_smoke_test/*.json
      - product/artifacts/runs/emodb/ci_smoke_test/*.png
    expire_in: 1 week